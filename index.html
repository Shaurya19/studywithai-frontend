<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StudyWithAI - Interactive Learning Platform</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Load environment configuration first -->
    <script src="/api/config"></script>
    <style>
        :root {
            --primary-color: #6366f1;
            --primary-dark: #4f46e5;
            --secondary-color: #ec4899;
            --success-color: #10b981;
            --error-color: #ef4444;
            --warning-color: #f59e0b;
            --bg-color: #0f172a;
            --card-bg: #1e293b;
            --text-primary: #f8fafc;
            --text-secondary: #94a3b8;
            --border-color: #334155;
            --shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, var(--bg-color) 0%, #1e293b 100%);
            color: var(--text-primary);
            line-height: 1.6;
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }

        .header {
            text-align: center;
            margin-bottom: 1.5rem;
            padding: 1rem 0;
        }

        .header h1 {
            font-size: 3rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 0.5rem;
        }

        .header p {
            font-size: 1.2rem;
            color: var(--text-secondary);
            max-width: 600px;
            margin: 0 auto;
        }

        .nav-tabs {
            display: flex;
            justify-content: center;
            margin-bottom: 1.5rem;
            gap: 1rem;
        }

        .nav-tab {
            padding: 1rem 2rem;
            background: var(--card-bg);
            border: 2px solid var(--border-color);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .nav-tab.active {
            background: var(--primary-color);
            border-color: var(--primary-color);
            box-shadow: 0 0 20px rgba(99, 102, 241, 0.3);
        }

        .nav-tab:hover {
            border-color: var(--primary-color);
            transform: translateY(-2px);
        }

        .content-section {
            display: none;
        }

        .content-section.active {
            display: block;
        }

        .input-form {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 1.5rem;
            box-shadow: var(--shadow);
            margin-bottom: 1.5rem;
            border: 1px solid var(--border-color);
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.3rem;
            font-weight: 500;
            color: var(--text-primary);
        }

        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 1rem;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            background: var(--bg-color);
            color: var(--text-primary);
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        .form-group textarea {
            min-height: 120px;
            resize: vertical;
        }

        .file-upload {
            position: relative;
            display: inline-block;
            cursor: pointer;
            width: 100%;
        }

        .file-upload input[type=file] {
            position: absolute;
            opacity: 0;
            width: 100%;
            height: 100%;
        }

        .file-upload-label {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2rem;
            border: 2px dashed var(--border-color);
            border-radius: 8px;
            background: var(--bg-color);
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .file-upload-label:hover {
            border-color: var(--primary-color);
            background: rgba(99, 102, 241, 0.1);
        }

        .file-upload-label i {
            font-size: 2rem;
            color: var(--primary-color);
            margin-right: 1rem;
        }

        .btn {
            padding: 1rem 2rem;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(99, 102, 241, 0.3);
        }

        .btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 2rem;
        }

        .loading.show {
            display: block;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid var(--border-color);
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .results {
            display: none;
        }

        .results.show {
            display: block;
        }

        /* Flashcards Styles */
        .flashcard {
            width: 100%;
            height: 250px;
            position: relative;
            perspective: 1000px;
            cursor: pointer;
        }

        .flashcard-inner {
            position: relative;
            width: 100%;
            height: 100%;
            text-align: center;
            transition: transform 0.8s;
            transform-style: preserve-3d;
        }

        .flashcard.flipped .flashcard-inner {
            transform: rotateY(180deg);
        }

        .flashcard-front, .flashcard-back {
            position: absolute;
            width: 100%;
            height: 100%;
            -webkit-backface-visibility: hidden;
            backface-visibility: hidden;
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1.5rem;
            box-sizing: border-box;
            border: 1px solid var(--border-color);
            box-shadow: var(--shadow);
            transition: box-shadow 0.3s ease;
            overflow: hidden;
        }

        .flashcard:hover .flashcard-front,
        .flashcard:hover .flashcard-back {
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        }

        .flashcard-content {
            font-size: 1.1rem;
            line-height: 1.5;
            word-wrap: break-word;
            overflow-wrap: break-word;
            hyphens: auto;
            max-width: 100%;
            max-height: 100%;
            overflow-y: auto;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0.5rem;
        }

        .flashcard-number {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: var(--primary-color);
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9rem;
            font-weight: 600;
            z-index: 10;
        }

        .flashcard-front {
            background: var(--card-bg);
            color: var(--text-primary);
        }

        .flashcard-back {
            background: white;
            color: var(--card-bg);
            transform: rotateY(180deg);
        }

        /* Quiz Styles */
        .quiz-container {
            max-width: 800px;
            margin: 0 auto;
        }

        .quiz-progress {
            background: var(--border-color);
            border-radius: 8px;
            height: 8px;
            margin-bottom: 1.5rem;
            overflow: hidden;
        }

        .quiz-progress-bar {
            background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
            height: 100%;
            transition: width 0.3s ease;
        }

        .quiz-question {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            border: 1px solid var(--border-color);
            box-shadow: var(--shadow);
        }

        .quiz-question h3 {
            font-size: 1.3rem;
            margin-bottom: 1rem;
            color: var(--text-primary);
        }

        .quiz-question p {
            margin-bottom: 1.5rem;
        }

        .quiz-options {
            display: grid;
            gap: 1rem;
        }

        .quiz-option {
            padding: 1rem 1.5rem;
            background: var(--bg-color);
            border: 2px solid var(--border-color);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .quiz-option:hover {
            border-color: var(--primary-color);
            background: rgba(99, 102, 241, 0.1);
        }

        .quiz-option.selected {
            border-color: var(--primary-color);
            background: rgba(99, 102, 241, 0.2);
        }

        .quiz-option.correct {
            border-color: var(--success-color);
            background: rgba(16, 185, 129, 0.2);
        }

        .quiz-option.incorrect {
            border-color: var(--error-color);
            background: rgba(239, 68, 68, 0.2);
        }

        .quiz-option-letter {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: var(--primary-color);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            flex-shrink: 0;
        }

        .quiz-explanation {
            margin-top: 0.8rem;
            padding: 1rem;
            background: rgba(99, 102, 241, 0.1);
            border-radius: 8px;
            border-left: 4px solid var(--primary-color);
            display: none;
        }

        .quiz-explanation.show {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        .quiz-navigation {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 1.5rem;
        }

        .quiz-score {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 2rem;
            text-align: center;
            border: 1px solid var(--border-color);
            box-shadow: var(--shadow);
        }

        .quiz-score h2 {
            font-size: 2.5rem;
            margin-bottom: 0.8rem;
            background: linear-gradient(135deg, var(--success-color), var(--primary-color));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .score-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-top: 1.5rem;
        }

        .score-item {
            background: var(--bg-color);
            padding: 1rem;
            border-radius: 12px;
            border: 1px solid var(--border-color);
        }

        .score-item h4 {
            font-size: 2rem;
            margin-bottom: 0.3rem;
        }

        .score-item.correct h4 {
            color: var(--success-color);
        }

        .score-item.incorrect h4 {
            color: var(--error-color);
        }

        .score-item.total h4 {
            color: var(--primary-color);
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes slideIn {
            from { transform: translateX(100%); }
            to { transform: translateX(0); }
        }

        .slide-in {
            animation: slideIn 0.3s ease;
        }

        .error-message {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid var(--error-color);
            color: var(--error-color);
            padding: 1rem;
            border-radius: 8px;
            margin-top: 1rem;
        }

        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }

            .header h1 {
                font-size: 2rem;
            }

            .nav-tabs {
                flex-direction: column;
            }

            .flashcard {
                min-height: 150px;
            }

            .quiz-navigation {
                flex-direction: column;
                gap: 1rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1><i class="fas fa-brain"></i> StudyWithAI</h1>
            <p>Transform your learning with AI-powered flashcards and interactive quizzes</p>
        </div>

        <div class="nav-tabs">
            <div class="nav-tab active" onclick="switchTab('flashcards')">
                <i class="fas fa-layer-group"></i> Flashcards
            </div>
            <div class="nav-tab" onclick="switchTab('quiz')">
                <i class="fas fa-question-circle"></i> Quiz
            </div>
        </div>

        <!-- Flashcards Section -->
        <div id="flashcards-section" class="content-section active">
            <div class="input-form">
                <h2><i class="fas fa-layer-group"></i> Generate Flashcards</h2>
                <form id="flashcard-form">
                    <div class="form-group">
                        <label for="flashcard-prompt">Study Content</label>
                        <textarea id="flashcard-prompt" placeholder="Enter the topic or content you want to create flashcards from..." required></textarea>
                    </div>
                    <div class="form-group">
                        <label for="num-flashcards">Number of Flashcards</label>
                        <input type="number" id="num-flashcards" min="1" max="50" value="10" placeholder="Enter number of flashcards (1-50)">
                    </div>
                    <div class="form-group">
                        <label>Upload PDF (Optional)</label>
                        <div class="file-upload">
                            <input type="file" id="flashcard-file" accept=".pdf" multiple>
                            <div class="file-upload-label">
                                <i class="fas fa-cloud-upload-alt"></i>
                                <span>Drop PDF files here or click to select</span>
                            </div>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-magic"></i> Generate Flashcards
                    </button>
                </form>
            </div>

            <div id="flashcard-loading" class="loading">
                <div class="spinner"></div>
                <p>Creating your flashcards...</p>
            </div>

            <div id="flashcard-results" class="results">
                <div id="flashcards-container" class="flashcards-container"></div>
            </div>
        </div>

        <!-- Quiz Section -->
        <div id="quiz-section" class="content-section">
            <div class="input-form">
                <h2><i class="fas fa-question-circle"></i> Generate Quiz</h2>
                <form id="quiz-form">
                    <div class="form-group">
                        <label for="quiz-prompt">Study Content</label>
                        <textarea id="quiz-prompt" placeholder="Enter the topic or content you want to create a quiz from..." required></textarea>
                    </div>
                    <div class="form-group">
                        <label for="num-questions">Number of Questions</label>
                        <input type="number" id="num-questions" min="1" max="20" value="5" placeholder="Enter number of questions (1-20)">
                    </div>
                    <div class="form-group">
                        <label>Upload PDF (Optional)</label>
                        <div class="file-upload">
                            <input type="file" id="quiz-file" accept=".pdf" multiple>
                            <div class="file-upload-label">
                                <i class="fas fa-cloud-upload-alt"></i>
                                <span>Drop PDF files here or click to select</span>
                            </div>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-play"></i> Generate Quiz
                    </button>
                </form>
            </div>

            <div id="quiz-loading" class="loading">
                <div class="spinner"></div>
                <p>Creating your quiz...</p>
            </div>

            <div id="quiz-results" class="results">
                <div class="quiz-container">
                    <div class="quiz-progress">
                        <div id="quiz-progress-bar" class="quiz-progress-bar" style="width: 0%"></div>
                    </div>
                    <div id="quiz-content"></div>
                </div>
            </div>
        </div>
    </div>

    <script src="config.js"></script>
    <script>
        // Global variables
        let currentTab = 'flashcards';
        let quizData = [];
        let currentQuestionIndex = 0;
        let userAnswers = [];
        let quizScore = { correct: 0, incorrect: 0, total: 0 };
        
        // Flashcard variables
        let flashcardData = [];
        let currentFlashcardIndex = 0;

        // Use API endpoint from config.js only
        const API_BASE_URL = window.CONFIG ? window.CONFIG.API_URL : 'http://localhost:8000';

        // Check API availability on page load
        async function checkAPIConnection() {
            try {
                const response = await fetch(`${API_BASE_URL}/health`);
                if (response.ok) {
                    console.log('✅ API connection successful');
                    return true;
                } else {
                    throw new Error('API not responding');
                }
            } catch (error) {
                console.error('❌ API connection failed:', error);
                showGlobalError('API server is not running. Please start the API server first.');
                return false;
            }
        }

        // Show global error message
        function showGlobalError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error-message';
            errorDiv.style.position = 'fixed';
            errorDiv.style.top = '20px';
            errorDiv.style.right = '20px';
            errorDiv.style.zIndex = '1000';
            errorDiv.style.maxWidth = '400px';
            errorDiv.innerHTML = `
                <i class="fas fa-exclamation-triangle"></i> 
                <strong>Connection Error:</strong><br>
                ${message}
                <button onclick="this.parentElement.remove()" style="float: right; background: none; border: none; color: inherit; cursor: pointer; font-size: 1.2em; margin-left: 10px;">&times;</button>
            `;
            document.body.appendChild(errorDiv);
            
            setTimeout(() => {
                if (errorDiv.parentElement) {
                    errorDiv.remove();
                }
            }, 10000);
        }

        // Tab switching
        function switchTab(tab) {
            // Update active tab
            document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
            document.querySelector(`.nav-tab:nth-child(${tab === 'flashcards' ? '1' : '2'})`).classList.add('active');
            
            // Update active section
            document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active'));
            document.getElementById(`${tab}-section`).classList.add('active');
            
            currentTab = tab;
        }

        // File upload handling
        function setupFileUpload(inputId) {
            const fileInput = document.getElementById(inputId);
            const label = fileInput.nextElementSibling;
            
            fileInput.addEventListener('change', function() {
                const files = Array.from(this.files);
                if (files.length > 0) {
                    label.innerHTML = `<i class="fas fa-check-circle"></i><span>${files.length} file(s) selected</span>`;
                } else {
                    label.innerHTML = `<i class="fas fa-cloud-upload-alt"></i><span>Drop PDF files here or click to select</span>`;
                }
            });
        }

        // Initialize file uploads
        setupFileUpload('flashcard-file');
        setupFileUpload('quiz-file');

        // Flashcard functionality
        document.getElementById('flashcard-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            // Check API connection first
            const isConnected = await checkAPIConnection();
            if (!isConnected) return;
            
            const prompt = document.getElementById('flashcard-prompt').value;
            const numFlashcards = document.getElementById('num-flashcards').value;
            const files = document.getElementById('flashcard-file').files;
            const submitBtn = this.querySelector('button[type="submit"]');
            
            // Disable form and show loading
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generating...';
            document.getElementById('flashcard-loading').classList.add('show');
            document.getElementById('flashcard-results').classList.remove('show');
            
            try {
                const formData = new FormData();
                formData.append('prompt', prompt);
                formData.append('num_flashcards', numFlashcards);
                
                for (let file of files) {
                    formData.append('files', file);
                }
                
                const response = await fetch(`${API_BASE_URL}/generate-flashcards`, {
                    method: 'POST',
                    body: formData
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                
                if (data.success && data.flashcards && data.flashcards.length > 0) {
                    // Hide the input form and loading
                    document.querySelector('#flashcards-section .input-form').style.display = 'none';
                    document.getElementById('flashcard-loading').classList.remove('show');
                    
                    displayFlashcards(data.flashcards);
                } else {
                    throw new Error(data.message || 'No flashcards were generated. Please try with different content.');
                }
            } catch (error) {
                console.error('Error:', error);
                showError('flashcard-loading', `Failed to generate flashcards: ${error.message}`);
            } finally {
                // Re-enable form (in case of error)
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i class="fas fa-magic"></i> Generate Flashcards';
                document.getElementById('flashcard-loading').classList.remove('show');
            }
        });

        // Quiz functionality
        document.getElementById('quiz-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            // Check API connection first
            const isConnected = await checkAPIConnection();
            if (!isConnected) return;
            
            const prompt = document.getElementById('quiz-prompt').value;
            const numQuestions = document.getElementById('num-questions').value;
            const files = document.getElementById('quiz-file').files;
            const submitBtn = this.querySelector('button[type="submit"]');
            
            // Disable form and show loading
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generating...';
            document.getElementById('quiz-loading').classList.add('show');
            document.getElementById('quiz-results').classList.remove('show');
            
            try {
                const formData = new FormData();
                formData.append('prompt', prompt);
                formData.append('num_questions', numQuestions);
                
                for (let file of files) {
                    formData.append('files', file);
                }
                
                const response = await fetch(`${API_BASE_URL}/generate-quiz`, {
                    method: 'POST',
                    body: formData
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                
                if (data.success && data.quiz_questions && data.quiz_questions.length > 0) {
                    // Hide the input form and loading
                    document.querySelector('#quiz-section .input-form').style.display = 'none';
                    document.getElementById('quiz-loading').classList.remove('show');
                    
                    quizData = data.quiz_questions;
                    currentQuestionIndex = 0;
                    userAnswers = [];
                    quizScore = { correct: 0, incorrect: 0, total: data.quiz_questions.length };
                    displayQuiz();
                } else {
                    throw new Error(data.message || 'No quiz questions were generated. Please try with different content.');
                }
            } catch (error) {
                console.error('Error:', error);
                showError('quiz-loading', `Failed to generate quiz: ${error.message}`);
            } finally {
                // Re-enable form (in case of error)
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i class="fas fa-play"></i> Generate Quiz';
                document.getElementById('quiz-loading').classList.remove('show');
            }
        });

        function displayFlashcards(flashcards) {
            if (flashcards.length === 0) {
                const container = document.getElementById('flashcards-container');
                container.innerHTML = '<p class="text-secondary">No flashcards were generated. Please try with different content.</p>';
                document.getElementById('flashcard-results').classList.add('show');
                return;
            }
            
            // Store flashcard data globally
            flashcardData = flashcards;
            currentFlashcardIndex = 0;
            
            displayCurrentFlashcard();
            updateFlashcardProgress();
            document.getElementById('flashcard-results').classList.add('show');
        }

        function displayCurrentFlashcard() {
            if (currentFlashcardIndex >= flashcardData.length) {
                displayFlashcardComplete();
                return;
            }

            const container = document.getElementById('flashcards-container');
            const card = flashcardData[currentFlashcardIndex];
            const front = escapeHtml(card.front || 'No question provided');
            const back = escapeHtml(card.back || 'No answer provided');
            
            container.innerHTML = `
                <div class="quiz-container">
                    <div class="quiz-progress">
                        <div id="flashcard-progress-bar" class="quiz-progress-bar" style="width: 0%"></div>
                    </div>
                    <div class="quiz-question slide-in">
                        <h3>Flashcard ${currentFlashcardIndex + 1} of ${flashcardData.length}</h3>
                        <div class="flashcard" id="current-flashcard">
                            <div class="flashcard-number">${card.number || currentFlashcardIndex + 1}</div>
                            <div class="flashcard-inner">
                                <div class="flashcard-side flashcard-front">
                                    <div class="flashcard-content">${front}</div>
                                </div>
                                <div class="flashcard-side flashcard-back">
                                    <div class="flashcard-content">${back}</div>
                                </div>
                            </div>
                        </div>
                        <div style="text-align: center; margin: 1rem 0; color: var(--text-secondary);">
                            <i class="fas fa-mouse-pointer"></i> Click the card or press <kbd style="background: var(--bg-color); padding: 0.2rem 0.4rem; border-radius: 4px; border: 1px solid var(--border-color);">Spacebar</kbd> to flip
                        </div>
                        <div class="quiz-navigation">
                            <button class="btn btn-primary" onclick="previousFlashcard()" id="prev-flashcard-btn" 
                                    ${currentFlashcardIndex === 0 ? 'style="visibility: hidden;"' : ''}>
                                <i class="fas fa-arrow-left"></i> Previous
                            </button>
                            <button class="btn btn-primary" onclick="nextFlashcard()" id="next-flashcard-btn">
                                ${currentFlashcardIndex === flashcardData.length - 1 ? 'Finish Study Session' : 'Next Flashcard'} 
                                <i class="fas fa-arrow-right"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            // Add click event to flip the flashcard
            document.getElementById('current-flashcard').addEventListener('click', function() {
                this.classList.toggle('flipped');
            });
            
            // Enable keyboard navigation for flashcards
            enableFlashcardKeyboardNavigation();
        }

        function nextFlashcard() {
            currentFlashcardIndex++;
            displayCurrentFlashcard();
            updateFlashcardProgress();
        }

        function previousFlashcard() {
            if (currentFlashcardIndex > 0) {
                currentFlashcardIndex--;
                displayCurrentFlashcard();
                updateFlashcardProgress();
            }
        }

        function updateFlashcardProgress() {
            const progress = (currentFlashcardIndex / flashcardData.length) * 100;
            const progressBar = document.getElementById('flashcard-progress-bar');
            if (progressBar) {
                progressBar.style.width = `${progress}%`;
            }
        }

        function displayFlashcardComplete() {
            const container = document.getElementById('flashcards-container');
            
            container.innerHTML = `
                <div class="quiz-container">
                    <div class="quiz-score">
                        <h2>Study Session Complete!</h2>
                        <div style="font-size: 3rem; margin: 2rem 0;">
                            <i class="fas fa-graduation-cap" style="color: var(--success-color);"></i>
                        </div>
                        <p style="font-size: 1.2rem; color: var(--text-secondary);">
                            You've reviewed all ${flashcardData.length} flashcards!
                        </p>
                        <div class="score-details">
                            <div class="score-item total">
                                <h4>${flashcardData.length}</h4>
                                <p>Flashcards Studied</p>
                            </div>
                        </div>
                        <div style="margin-top: 2rem; display: flex; gap: 1rem; justify-content: center; flex-wrap: wrap;">
                            <button class="btn btn-primary" onclick="restartFlashcards()">
                                <i class="fas fa-redo"></i> Study Again
                            </button>
                            <button class="btn btn-primary" onclick="shuffleFlashcards()">
                                <i class="fas fa-random"></i> Shuffle & Study
                            </button>
                            <button class="btn btn-primary" onclick="createNewFlashcards()" style="background: var(--secondary-color);">
                                <i class="fas fa-plus"></i> New Flashcards
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        function restartFlashcards() {
            currentFlashcardIndex = 0;
            displayCurrentFlashcard();
            updateFlashcardProgress();
        }

        function shuffleFlashcards() {
            // Shuffle the flashcard array
            for (let i = flashcardData.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [flashcardData[i], flashcardData[j]] = [flashcardData[j], flashcardData[i]];
            }
            currentFlashcardIndex = 0;
            displayCurrentFlashcard();
            updateFlashcardProgress();
        }

        function createNewFlashcards() {
            // Show the input form again
            document.querySelector('#flashcards-section .input-form').style.display = 'block';
            
            // Hide the flashcard results
            document.getElementById('flashcard-results').classList.remove('show');
            
            // Reset form
            document.getElementById('flashcard-form').reset();
            document.querySelector('#flashcard-file').nextElementSibling.innerHTML = '<i class="fas fa-cloud-upload-alt"></i><span>Drop PDF files here or click to select</span>';
            
            // Clear flashcard data
            flashcardData = [];
            currentFlashcardIndex = 0;
            
            // Disable keyboard navigation
            disableFlashcardKeyboardNavigation();
        }

        function displayQuiz() {
            if (currentQuestionIndex < quizData.length) {
                displayQuestion(quizData[currentQuestionIndex]);
            } else {
                displayQuizResults();
            }
            
            updateProgressBar();
            document.getElementById('quiz-results').classList.add('show');
        }

        function displayQuestion(question) {
            const content = document.getElementById('quiz-content');
            
            // Validate question data
            if (!question.question || !question.options || !Array.isArray(question.options) || question.options.length === 0) {
                content.innerHTML = '<div class="error-message">Invalid question data received.</div>';
                return;
            }
            
            const questionText = escapeHtml(question.question);
            const explanation = escapeHtml(question.explanation || 'No explanation provided');
            
            content.innerHTML = `
                <div class="quiz-question slide-in">
                    <h3>Question ${currentQuestionIndex + 1} of ${quizData.length}</h3>
                    <p><strong>${questionText}</strong></p>
                    <div class="quiz-options">
                        ${question.options.map((option, index) => `
                            <div class="quiz-option" data-option="${escapeHtml(option)}" onclick="selectOption(this, '${escapeHtml(option)}', '${escapeHtml(question.answer)}')">
                                <div class="quiz-option-letter">${String.fromCharCode(65 + index)}</div>
                                <span>${escapeHtml(option)}</span>
                            </div>
                        `).join('')}
                    </div>
                    <div class="quiz-explanation" id="explanation">
                        <strong>Explanation:</strong> ${explanation}
                    </div>
                    <div class="quiz-navigation">
                        <button class="btn btn-primary" onclick="nextQuestion()" id="next-btn" style="display: none;">
                            ${currentQuestionIndex === quizData.length - 1 ? 'Finish Quiz' : 'Next Question'} 
                            <i class="fas fa-arrow-right"></i>
                        </button>
                    </div>
                </div>
            `;
        }

        function selectOption(element, selectedAnswer, correctAnswer) {
            // Prevent multiple selections
            const options = document.querySelectorAll('.quiz-option');
            options.forEach(opt => {
                opt.style.pointerEvents = 'none';
            });
            
            // Mark selected option
            element.classList.add('selected');
            
            // Show correct and incorrect answers
            options.forEach(opt => {
                const optionText = opt.dataset.option;
                if (optionText === correctAnswer) {
                    opt.classList.add('correct');
                } else if (opt === element && optionText !== correctAnswer) {
                    opt.classList.add('incorrect');
                }
            });
            
            // Record answer
            const isCorrect = selectedAnswer === correctAnswer;
            userAnswers.push({
                question: quizData[currentQuestionIndex].question,
                selected: selectedAnswer,
                correct: correctAnswer,
                isCorrect: isCorrect
            });
            
            if (isCorrect) {
                quizScore.correct++;
            } else {
                quizScore.incorrect++;
            }
            
            // Show explanation and next button
            document.getElementById('explanation').classList.add('show');
            document.getElementById('next-btn').style.display = 'block';
        }

        function nextQuestion() {
            currentQuestionIndex++;
            displayQuiz();
        }

        function displayQuizResults() {
            const percentage = Math.round((quizScore.correct / quizScore.total) * 100);
            const content = document.getElementById('quiz-content');
            
            content.innerHTML = `
                <div class="quiz-score">
                    <h2>Quiz Complete!</h2>
                    <div style="font-size: 4rem; margin: 2rem 0;">${percentage}%</div>
                    <p style="font-size: 1.2rem; color: var(--text-secondary);">
                        You scored ${quizScore.correct} out of ${quizScore.total} questions correctly
                    </p>
                    <div class="score-details">
                        <div class="score-item correct">
                            <h4>${quizScore.correct}</h4>
                            <p>Correct</p>
                        </div>
                        <div class="score-item incorrect">
                            <h4>${quizScore.incorrect}</h4>
                            <p>Incorrect</p>
                        </div>
                        <div class="score-item total">
                            <h4>${quizScore.total}</h4>
                            <p>Total</p>
                        </div>
                    </div>
                    <button class="btn btn-primary" onclick="restartQuiz()" style="margin-top: 2rem;">
                        <i class="fas fa-redo"></i> Take Quiz Again
                    </button>
                    <button class="btn btn-primary" onclick="createNewQuiz()" style="background: var(--secondary-color); margin-top: 2rem; margin-left: 1rem;">
                        <i class="fas fa-plus"></i> New Quiz
                    </button>
                </div>
            `;
        }

        function restartQuiz() {
            currentQuestionIndex = 0;
            userAnswers = [];
            quizScore = { correct: 0, incorrect: 0, total: quizData.length };
            displayQuiz();
        }

        function createNewQuiz() {
            // Show the input form again
            document.querySelector('#quiz-section .input-form').style.display = 'block';
            
            // Hide the quiz results
            document.getElementById('quiz-results').classList.remove('show');
            
            // Reset form
            document.getElementById('quiz-form').reset();
            document.querySelector('#quiz-file').nextElementSibling.innerHTML = '<i class="fas fa-cloud-upload-alt"></i><span>Drop PDF files here or click to select</span>';
            
            // Clear quiz data
            quizData = [];
            currentQuestionIndex = 0;
            userAnswers = [];
            quizScore = { correct: 0, incorrect: 0, total: 0 };
        }

        function updateProgressBar() {
            const progress = (currentQuestionIndex / quizData.length) * 100;
            document.getElementById('quiz-progress-bar').style.width = `${progress}%`;
        }

        function showError(containerId, message) {
            const container = document.getElementById(containerId);
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error-message';
            errorDiv.innerHTML = `<i class="fas fa-exclamation-triangle"></i> ${message}`;
            container.appendChild(errorDiv);
            
            setTimeout(() => {
                errorDiv.remove();
            }, 5000);
        }

        // Utility function to escape HTML
        function escapeHtml(text) {
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.replace(/[&<>"']/g, function(m) { return map[m]; });
        }

        // Check API connection on page load
        checkAPIConnection();

        // Add keyboard navigation for flashcards
        function enableFlashcardKeyboardNavigation() {
            // Remove any existing event listeners to prevent duplicates
            document.removeEventListener('keydown', handleFlashcardKeypress);
            document.addEventListener('keydown', handleFlashcardKeypress);
        }

        function handleFlashcardKeypress(event) {
            // Only handle keyboard events when we're in flashcard mode and flashcards are displayed
            if (currentTab !== 'flashcards' || !document.getElementById('current-flashcard')) {
                return;
            }

            // Prevent default behavior for the keys we're handling
            switch(event.code) {
                case 'Space':
                    event.preventDefault();
                    flipCurrentFlashcard();
                    break;
                case 'ArrowLeft':
                    event.preventDefault();
                    if (currentFlashcardIndex > 0) {
                        previousFlashcard();
                    }
                    break;
                case 'ArrowRight':
                    event.preventDefault();
                    nextFlashcard();
                    break;
            }
        }

        function flipCurrentFlashcard() {
            const currentFlashcard = document.getElementById('current-flashcard');
            if (currentFlashcard) {
                currentFlashcard.classList.toggle('flipped');
            }
        }

        // Disable flashcard keyboard navigation when leaving flashcard mode
        function disableFlashcardKeyboardNavigation() {
            document.removeEventListener('keydown', handleFlashcardKeypress);
        }
    </script>
</body>
</html>